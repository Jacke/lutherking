# üé§ WebRTC –ó–∞–ø–∏—Å—å –∏ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è - –ü–æ–ª–Ω—ã–π Flow

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–±—ä—è—Å–Ω—è–µ—Ç –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞ —á–µ—Ä–µ–∑ WebRTC –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≤ Orator AI.

---

## üìä –û–±—â–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ë—Ä–∞—É–∑–µ—Ä   ‚îÇ ‚îÄ‚îÄ‚îÄ> ‚îÇ  /api/call/  ‚îÇ ‚îÄ‚îÄ‚îÄ> ‚îÇ  /api/eval  ‚îÇ ‚îÄ‚îÄ‚îÄ> ‚îÇ   /result    ‚îÇ
‚îÇ   (WebRTC)  ‚îÇ      ‚îÇ    upload    ‚îÇ      ‚îÇ  (Whisper)  ‚îÇ      ‚îÇ   (UI)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚Üì                     ‚Üì                     ‚Üì                     ‚Üì
  –ó–∞–ø–∏—Å—å              –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ           –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è          –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  –∞—É–¥–∏–æ               —Ñ–∞–π–ª–∞ .webm          + AI –∞–Ω–∞–ª–∏–∑           —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```

---

## üîÑ –ü–æ—à–∞–≥–æ–≤—ã–π Flow

### **–®–∞–≥ 1: –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É** üì±

**–§–∞–π–ª:** [app/call/page.tsx:67-73](app/call/page.tsx#L67-L73)

```typescript
const stream = await navigator.mediaDevices.getUserMedia({
  audio: {
    echoCancellation: true,      // –£–±–∏—Ä–∞–µ—Ç —ç—Ö–æ
    noiseSuppression: true,       // –ü–æ–¥–∞–≤–ª—è–µ—Ç —Ñ–æ–Ω–æ–≤—ã–π —à—É–º
    sampleRate: 44100,            // –ö–∞—á–µ—Å—Ç–≤–æ –∑–≤—É–∫–∞ (44.1 kHz)
  }
});
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç popup: "–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É?"
3. –ü–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è `MediaStream` –æ–±—ä–µ–∫—Ç
4. Stream —Å–æ–¥–µ—Ä–∂–∏—Ç –∞—É–¥–∏–æ-–¥–æ—Ä–æ–∂–∫—É (audio track) —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

---

### **–®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MediaRecorder** üéôÔ∏è

**–§–∞–π–ª:** [app/call/page.tsx:78-94](app/call/page.tsx#L78-L94)

```typescript
// –°–æ–∑–¥–∞–µ–º MediaRecorder —Å —Ñ–æ—Ä–º–∞—Ç–æ–º WebM + Opus codec
const options = { mimeType: 'audio/webm;codecs=opus' };
const mediaRecorder = new MediaRecorder(stream, options);

// –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É—Å–∫–æ–≤ –∞—É–¥–∏–æ
audioChunksRef.current = [];

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
mediaRecorder.ondataavailable = (event) => {
  if (event.data.size > 0) {
    audioChunksRef.current.push(event.data);  // –î–æ–±–∞–≤–ª—è–µ–º chunk
  }
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏
mediaRecorder.onstop = async () => {
  await uploadAudio();  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
};

// –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å!
mediaRecorder.start();
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. `MediaRecorder` –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å stream
2. –ê—É–¥–∏–æ —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ **chunks** (–∫—É—Å–æ—á–∫–∏ –ø–æ ~1 —Å–µ–∫—É–Ω–¥–µ)
3. –ö–∞–∂–¥—ã–π chunk —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –º–∞—Å—Å–∏–≤ `audioChunksRef`
4. –§–æ—Ä–º–∞—Ç: **WebM** —Å –∫–æ–¥–µ–∫–æ–º **Opus** (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Å–∂–∞—Ç–∏–µ)

**–ü–æ—á–µ–º—É WebM + Opus?**
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤—Å–µ–º–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏
- ‚úÖ –•–æ—Ä–æ—à–µ–µ —Å–∂–∞—Ç–∏–µ (–º–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞)
- ‚úÖ –û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∑–≤—É–∫–∞
- ‚úÖ Whisper API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebM

---

### **–®–∞–≥ 3: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞** üåä

**–§–∞–π–ª:** [app/call/page.tsx:105-158](app/call/page.tsx#L105-L158)

```typescript
const audioContext = new AudioContext();
const analyser = audioContext.createAnalyser();
analyser.fftSize = 2048;  // –†–∞–∑–º–µ—Ä FFT –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —á–∞—Å—Ç–æ—Ç

// –ü–æ–¥–∫–ª—é—á–∞–µ–º stream –∫ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—É
const source = audioContext.createMediaStreamSource(stream);
source.connect(analyser);

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ waveform
const bufferLength = analyser.frequencyBinCount;
const dataArray = new Uint8Array(bufferLength);

// –†–∏—Å—É–µ–º waveform –Ω–∞ canvas
const draw = () => {
  analyser.getByteTimeDomainData(dataArray);  // –ü–æ–ª—É—á–∞–µ–º –∞–º–ø–ª–∏—Ç—É–¥—É

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–æ–ª–Ω—ã –Ω–∞ canvas (—Å–∏–Ω—è—è –ª–∏–Ω–∏—è)
  for (let i = 0; i < bufferLength; i++) {
    const v = dataArray[i] / 128.0;
    const y = (v * canvas.height) / 2;
    canvasCtx.lineTo(x, y);
    x += sliceWidth;
  }
};
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. `AudioContext` —Å–æ–∑–¥–∞–µ—Ç Web Audio API –≥—Ä–∞—Ñ
2. `AnalyserNode` –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
3. `getByteTimeDomainData()` –ø–æ–ª—É—á–∞–µ—Ç –∞–º–ø–ª–∏—Ç—É–¥—É –∑–≤—É–∫–∞
4. Canvas –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Å–∏–Ω—é—é –≤–æ–ª–Ω—É (waveform)

**–≠—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –∑–∞–ø–∏—Å—å!** –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø–∏—Å—å —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

---

### **–®–∞–≥ 4: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞** ‚èπÔ∏è

**–§–∞–π–ª:** [app/call/page.tsx:167-211](app/call/page.tsx#L167-L211)

```typescript
const uploadAudio = async () => {
  // 1. –°–æ–∑–¥–∞–µ–º Blob –∏–∑ –≤—Å–µ—Ö chunks
  const audioBlob = new Blob(audioChunksRef.current, {
    type: 'audio/webm;codecs=opus'
  });

  // 2. –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è HTTP upload
  const formData = new FormData();
  formData.append('audio', audioBlob, `${sessionId}.webm`);
  formData.append('sessionId', sessionId!);

  // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  const uploadRes = await fetch('/api/call/upload', {
    method: 'POST',
    body: formData,
  });

  // 4. –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–µ—Å—Å–∏—é (–∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é)
  const endRes = await fetch('/api/call/end', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sessionId }),
  });

  // 5. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  router.push(`/result?sessionId=${sessionId}`);
};
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –í—Å–µ chunks –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –æ–¥–∏–Ω **Blob** (binary large object)
2. Blob –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ **FormData** (–¥–ª—è multipart/form-data upload)
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è POST –Ω–∞ `/api/call/upload`
4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `/api/call/end`
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `/result`

---

### **–®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ** üíæ

**–§–∞–π–ª:** [pages/api/call/upload.ts:16-90](pages/api/call/upload.ts#L16-L90)

```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ–º formidable –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ FormData
const form = new IncomingForm({
  uploadDir: path.join(process.cwd(), 'storage', 'sessions'),
  keepExtensions: true,
  maxFileSize: 50 * 1024 * 1024,  // 50MB max
});

// –ü–∞—Ä—Å–∏–º FormData
const { fields, files } = await new Promise((resolve, reject) => {
  form.parse(req, (err, fields, files) => {
    if (err) reject(err);
    else resolve({ fields, files });
  });
});

// –ò–∑–≤–ª–µ–∫–∞–µ–º sessionId –∏ —Ñ–∞–π–ª
const sessionId = fields.sessionId[0];
const audioFile = files.audio[0];

// –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —Ñ–∞–π–ª: sessionId.webm
const originalPath = audioFile.filepath;
const newPath = path.join(uploadDir, `${sessionId}.webm`);
fs.renameSync(originalPath, newPath);

// –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –ë–î
await db.update(sessions)
  .set({ wavPath: newPath })
  .where(eq(sessions.sessionId, sessionId))
  .run();
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. `formidable` –ø–∞—Ä—Å–∏—Ç multipart/form-data
2. –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
3. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç—Å—è –≤ `{sessionId}.webm`
4. –ü—É—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `sessions`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§–∞–π–ª –ª–µ–∂–∏—Ç –≤ `/storage/sessions/abc-123-xyz.webm`

---

### **–®–∞–≥ 6: –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —á–µ—Ä–µ–∑ Whisper** ü§ñ

**–§–∞–π–ª:** [pages/api/eval.ts:103-122](pages/api/eval.ts#L103-L122)

```typescript
async function transcribeAudio(audioPath: string) {
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ stream
  const audioFile = fs.createReadStream(audioPath);

  // –í—ã–∑—ã–≤–∞–µ–º OpenAI Whisper API
  const transcription = await openai.audio.transcriptions.create({
    file: audioFile,               // WebM —Ñ–∞–π–ª
    model: 'whisper-1',            // –ú–æ–¥–µ–ª—å Whisper
    language: 'ru',                // –†—É—Å—Å–∫–∏–π —è–∑—ã–∫ (–º–æ–∂–Ω–æ 'en')
    response_format: 'verbose_json', // –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç —Å timestamps
    timestamp_granularities: ['word'], // Timestamps –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞
  });

  return {
    text: transcription.text  // –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç —Ç–µ–∫—Å—Ç–∞
  };
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. Whisper API –ø–æ–ª—É—á–∞–µ—Ç —Ñ–∞–π–ª `.webm`
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç** WebM ‚Üí –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç
3. –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ä–µ—á—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç + timestamps –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ–≤–∞

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "text": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –º–µ–Ω—è –∑–æ–≤—É—Ç –ò–≤–∞–Ω. –Ø —Ö–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ.",
  "words": [
    { "word": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "start": 0.0, "end": 0.8 },
    { "word": "–º–µ–Ω—è", "start": 0.9, "end": 1.1 },
    { "word": "–∑–æ–≤—É—Ç", "start": 1.2, "end": 1.5 },
    ...
  ]
}
```

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~$0.006 –∑–∞ –º–∏–Ω—É—Ç—É –∞—É–¥–∏–æ

---

### **–®–∞–≥ 7: AI –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ GPT-4** üß†

**–§–∞–π–ª:** [pages/api/eval.ts:127-209](pages/api/eval.ts#L127-L209)

```typescript
async function analyzeTranscript(transcript: string) {
  const prompt = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –ø—É–±–ª–∏—á–Ω—ã—Ö –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π.
  –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é —Ä–µ—á–∏:

  "${transcript}"

  –û—Ü–µ–Ω–∏ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º:
  1. Clarity Score (0-100)
  2. Filler Words (—ç–º, –Ω—É, –≤–æ—Ç, —Ç–∏–ø–∞)
  3. Tone (confident/nervous/professional)
  4. Confidence (0-100)
  5. Highlights (3-5 –∑–∞–º–µ—á–∞–Ω–∏–π)
  6. Detailed Feedback (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)

  –í–µ—Ä–Ω–∏ JSON:
  {
    "clarity_score": 75,
    "filler_words": "—ç–º (3 —Ä–∞–∑–∞), –Ω—É (2 —Ä–∞–∑–∞)",
    "tone": "confident",
    "confidence": 80,
    "highlights": ["–•–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–Ω–æ–≥–æ –ø–∞—É–∑"],
    "text": "–í–∞—à–∞ —Ä–µ—á—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç..."
  }`;

  const completion = await openai.chat.completions.create({
    model: 'gpt-4-turbo-preview',
    messages: [
      { role: 'system', content: '–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—É–±–ª–∏—á–Ω—ã–º –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è–º.' },
      { role: 'user', content: prompt }
    ],
    temperature: 0.7,
    response_format: { type: 'json_object' }  // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç JSON –æ—Ç–≤–µ—Ç
  });

  return JSON.parse(completion.choices[0].message.content);
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. GPT-4 –ø–æ–ª—É—á–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç —Ç–µ–∫—Å—Ç–∞
2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —Å–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã, —Ç–æ–Ω
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
4. –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `callHistory`

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~$0.03 –∑–∞ 1K —Ç–æ–∫–µ–Ω–æ–≤ (–ø—Ä–∏–º–µ—Ä–Ω–æ $0.05 –∑–∞ –∞–Ω–∞–ª–∏–∑)

---

## üìÅ –ò—Ç–æ–≥–æ–≤–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–∞–Ω–Ω—ã—Ö

### **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (`callHistory` —Ç–∞–±–ª–∏—Ü–∞):**

```sql
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ id ‚îÇ userId  ‚îÇ sessionId  ‚îÇ challengeId  ‚îÇ clarityScore ‚îÇ fillerWords  ‚îÇ tone      ‚îÇ confidence ‚îÇ feedback       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1  ‚îÇ 123     ‚îÇ abc-xyz    ‚îÇ 1            ‚îÇ 75           ‚îÇ —ç–º (3), –Ω—É(2)‚îÇ confident ‚îÇ 80         ‚îÇ "–•–æ—Ä–æ—à–∞—è..."   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:**

```
/storage/
  ‚îî‚îÄ‚îÄ sessions/
      ‚îú‚îÄ‚îÄ abc-123-xyz.webm   (–∑–∞–ø–∏—Å–∞–Ω–Ω—ã–π –∞—É–¥–∏–æ —Ñ–∞–π–ª)
      ‚îú‚îÄ‚îÄ def-456-uvw.webm
      ‚îî‚îÄ‚îÄ ...
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –î–µ—Ç–∞–ª–∏

### **–§–æ—Ä–º–∞—Ç—ã –∞—É–¥–∏–æ:**

| –§–æ—Ä–º–∞—Ç | Codec | –†–∞–∑–º–µ—Ä (1 –º–∏–Ω) | –ö–∞—á–µ—Å—Ç–≤–æ | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Whisper |
|--------|-------|----------------|----------|-------------------|
| WebM   | Opus  | ~500 KB        | –û—Ç–ª–∏—á–Ω–æ  | ‚úÖ –î–∞             |
| MP3    | MP3   | ~1 MB          | –•–æ—Ä–æ—à–æ   | ‚úÖ –î–∞             |
| WAV    | PCM   | ~10 MB         | –õ—É—á—à–µ–µ   | ‚úÖ –î–∞             |
| M4A    | AAC   | ~800 KB        | –•–æ—Ä–æ—à–æ   | ‚úÖ –î–∞             |

**–í—ã–≤–æ–¥:** WebM + Opus - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä (–º–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä + —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)

---

### **Web Audio API –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MediaStream‚îÇ ‚îÄ‚îÄ‚îÄ> ‚îÇ Analyser ‚îÇ ‚îÄ‚îÄ‚îÄ> ‚îÇ  Canvas  ‚îÇ
‚îÇ  (–º–∏–∫—Ä–æ—Ñ–æ–Ω)‚îÇ      ‚îÇ  Node    ‚îÇ      ‚îÇ(–≤–∏–∑—É–∞–ª.) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇMediaRecorder ‚îÄ‚îÄ‚îÄ> ‚îÇ  Chunks  ‚îÇ ‚îÄ‚îÄ‚îÄ> ‚îÇ   Blob   ‚îÇ
‚îÇ   (–∑–∞–ø–∏—Å—å) ‚îÇ      ‚îÇ (–º–∞—Å—Å–∏–≤) ‚îÇ      ‚îÇ (—Ñ–∞–π–ª)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–í–∞–∂–Ω–æ:** `MediaRecorder` –∏ `AnalyserNode` —Ä–∞–±–æ—Ç–∞—é—Ç **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ**!

---

## üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### **1. Streaming —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (–±—É–¥—É—â–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ):**

–í–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–≥–æ —Ñ–∞–π–ª–∞ –º–æ–∂–Ω–æ —Å—Ç—Ä–∏–º–∏—Ç—å chunks –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:

```typescript
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π chunk —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏
mediaRecorder.ondataavailable = async (event) => {
  if (event.data.size > 0) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º chunk –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    await fetch('/api/transcribe-chunk', {
      method: 'POST',
      body: event.data,
    });
  }
};
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
- –ù–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

---

### **2. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ WAV (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**

–ï—Å–ª–∏ –Ω—É–∂–µ–Ω WAV —Ñ–æ—Ä–º–∞—Ç (–±–æ–ª–µ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π):

```bash
# –ò—Å–ø–æ–ª—å–∑—É–µ–º FFmpeg –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
ffmpeg -i input.webm -ar 16000 -ac 1 output.wav
```

**–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ:**
- –õ–æ–∫–∞–ª—å–Ω—ã–µ ML –º–æ–¥–µ–ª–∏ —Ç—Ä–µ–±—É—é—Ç WAV
- –ù—É–∂–µ–Ω –Ω–µ—Å–∂–∞—Ç—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π Flow (–µ—â–µ —Ä–∞–∑)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫"
   ‚îî‚îÄ> navigator.mediaDevices.getUserMedia() - –∑–∞–ø—Ä–æ—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

2. MediaRecorder –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–ø–∏—Å—å
   ‚îî‚îÄ> Chunks —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –º–∞—Å—Å–∏–≤

3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
   ‚îî‚îÄ> mediaRecorder.stop() –≤—ã–∑—ã–≤–∞–µ—Ç uploadAudio()

4. Blob –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
   ‚îî‚îÄ> POST /api/call/upload ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç .webm —Ñ–∞–π–ª

5. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è /api/call/end
   ‚îî‚îÄ> POST /api/eval ‚Üí —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è + –∞–Ω–∞–ª–∏–∑

6. Whisper API —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ
   ‚îî‚îÄ> –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç —Ä–µ—á–∏

7. GPT-4 –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
   ‚îî‚îÄ> –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ (clarity, confidence, tone)

8. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ callHistory
   ‚îî‚îÄ> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç feedback –Ω–∞ /result
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ß—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å flow:

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä
npm run dev

# 2. –û—Ç–∫—Ä—ã—Ç—å http://localhost:3000

# 3. –í–æ–π—Ç–∏ –∫–∞–∫ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
# Email: test@orator.ai
# Password: test123

# 4. –í—ã–±—Ä–∞—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂

# 5. –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É

# 6. –ì–æ–≤–æ—Ä–∏—Ç—å 30-60 —Å–µ–∫—É–Ω–¥

# 7. –ù–∞–∂–∞—Ç—å "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫"

# 8. –£–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ /result
```

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [MDN: MediaRecorder API](https://developer.mozilla.org/en-US/docs/Web/API/MediaRecorder)
- [MDN: Web Audio API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API)
- [OpenAI Whisper API](https://platform.openai.com/docs/guides/speech-to-text)
- [WebM Format](https://www.webmproject.org/)
- [Opus Codec](https://opus-codec.org/)

---

**–ê–≤—Ç–æ—Ä:** Claude + Stan
**–î–∞—Ç–∞:** 26 –æ–∫—Ç—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è:** 1.0
